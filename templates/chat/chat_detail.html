{% extends 'base.html' %}
{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<style>
  html, body { height:100%; background:#2a2a2e; margin:0; }
  .chat-container {
    max-width:700px;
    height:calc(100vh - 70px);
    margin:auto;
    background:#2b2b2f;
    border-radius:12px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .chat-header {
    padding:1rem;
    background:#3a3a3f;
    border-bottom:1px solid #555;
    display:flex;
    align-items:center;
  }
  .chat-header img {
    width:42px;
    height:42px;
    border-radius:50%;
    margin-right:12px;
    border:2px solid #4dabf7;
  }
  .chat-header h5 {
    color:#f1f1f1;
    margin:0;
    font-weight:600;
  }
  .chat-body {
    flex:1;
    overflow-y:auto;
    padding:1rem;
    background:#2a2a2e;
    display:flex;
    flex-direction:column;
  }
  .chat-message {
    margin-bottom:14px;
    max-width:75%;
    padding:.6rem 1rem;
    border-radius:20px;
    word-wrap:break-word;
    font-size:.95rem;
    line-height:1.4;
    transition:background .2s;
  }
  .sent {
    background:#4dabf7;
    align-self:flex-end;
    color:#fff;
  }
  .received {
    background:#3b3b3f;
    align-self:flex-start;
    color:#e0e0e0;
  }
  .chat-timestamp {
    font-size:.75rem;
    color:#bbbbbb;
    margin-top:4px;
    text-align:right;
  }
  .chat-footer {
    position:relative;
    padding:.8rem 1rem;
    border-top:1px solid #444;
    background:#3a3a3f;
  }
  .chat-footer .input-group {
    display:flex;
  }
  .chat-footer .form-control {
    background:#1f1f23;
    border:1px solid #555;
    color:#fff;
    border-radius:20px 0 0 20px;
    height:42px;
    flex:1;
    padding:.5rem 1rem;
  }
  .chat-footer .form-control::placeholder {
    color:#aaaaaa;
  }
  .chat-footer .btn-outline-secondary {
    border-radius:20px 0 0 20px;
    background:#2a2a2e;
    color:#ddd;
    border:1px solid #444;
    margin-right:-1px;
  }
  .chat-footer .btn-outline-secondary:hover {
    background:#444;
    color:#fff;
  }
  .chat-footer .btn-success {
    background:#4dabf7;
    border:none;
    border-radius:0 20px 20px 0;
    margin-left:-1px;
  }
  .chat-footer .btn-success:hover {
    background:#339af0;
  }
  #emoji-picker {
    display:none;
    position:absolute;
    bottom:50px;
    left:10px;
    width:320px;
    max-height:220px;
    background:#3a3a3f;
    border:1px solid #555;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.4);
    padding:8px;
    overflow-y:auto;
    z-index:1000;
  }
  #emoji-picker .emoji {
    font-size:1.5rem;
    margin:4px;
    cursor:pointer;
    display:inline-block;
    transition:transform .15s;
  }
  #emoji-picker .emoji:hover {
    transform:scale(1.2);
  }
</style>

<div class="container-fluid px-2 px-md-0 py-3">
  <div class="chat-container">

    <!-- Header -->
    <div class="chat-header">
      <img src="{{ other_user.profile.profile_pic.url }}" alt="Profile Picture">
      <h5>@{{ other_user.username }}</h5>
    </div>

    <!-- Messages -->
    <div class="chat-body" id="chat-body">
      {% if chat_messages %}
        {% for msg in chat_messages %}
          {% if msg.sender == request.user %}
            <div class="chat-message sent">
          {% else %}
            <div class="chat-message received">
          {% endif %}
              {{ msg.text|linebreaksbr }}
              <div class="chat-timestamp">{{ msg.timestamp|date:"M d, H:i" }}</div>
            </div>
        {% endfor %}
      {% else %}
        <div class="text-center text-muted mt-5" style="color:#bbb;">
          No messages yet. Start the conversation!
        </div>
      {% endif %}
    </div>

    <!-- Footer -->
    <div class="chat-footer">
      <form method="POST" id="chat-form">
        {% csrf_token %}
        <div class="input-group">
          <button type="button" id="emoji-btn" class="btn btn-outline-secondary" title="Insert emoji">ðŸ˜Š</button>
          <div id="emoji-picker"></div>
          <input id="message-input" name="message" type="text" class="form-control"
                 placeholder="Type a message..." autocomplete="off" required>
          <button class="btn btn-success" type="submit">Send</button>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
  // Scroll to bottom
  const chatBody = document.getElementById('chat-body');
  if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;

  const emojiBtn = document.getElementById('emoji-btn');
  const pickerDiv = document.getElementById('emoji-picker');
  const msgInput = document.getElementById('message-input');

  // Load first 300 emojis
  fetch('https://unpkg.com/emoji.json@13.1.0/emoji.json')
    .then(res => res.json())
    .then(list => {
      list.slice(0,300).forEach(e => {
        const span = document.createElement('span');
        span.textContent = e.char;
        span.className = 'emoji';
        span.addEventListener('click', () => {
          msgInput.value += e.char;
          msgInput.focus();
        });
        pickerDiv.append(span);
      });
    })
    .catch(console.error);

  // Toggle emoji panel
  emojiBtn.addEventListener('click', e => {
    e.stopPropagation();
    pickerDiv.style.display = pickerDiv.style.display === 'block' ? 'none' : 'block';
  });

  // Close on outside click
  document.addEventListener('click', e => {
    if (!pickerDiv.contains(e.target) && e.target !== emojiBtn) {
      pickerDiv.style.display = 'none';
    }
  });
</script>
{% endblock %}












